{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Record Savings Deposit - Cooperative Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Record Savings Deposit
                </h5>
            </div>
            
            <div class="card-body">
                <form method="post" id="depositForm">
                    {% csrf_token %}
                    
                    <!-- Member Selection -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fas fa-user me-2"></i>Member Information
                                    </h6>
                                    {% crispy form %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balance Display -->
                    <div class="row mb-3" id="balanceInfo" style="display: none;">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <h6>Current Balance</h6>
                                        <h4 id="currentBalance">₦0.00</h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Minimum Balance</h6>
                                        <h4 id="minimumBalance">₦0.00</h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>New Balance</h6>
                                        <h4 id="newBalance" class="text-success">₦0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction Summary -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-receipt me-2"></i>Transaction Summary
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Date:</strong> {{ current_date|date:"M d, Y" }}</p>
                                            <p><strong>Time:</strong> {{ current_time|time:"H:i" }}</p>
                                            <p><strong>Processed By:</strong> {{ user.get_full_name }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Transaction Type:</strong> Savings Deposit</p>
                                            <p><strong>Reference:</strong> <span id="transactionRef">Will be generated</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'savings:accounts' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Accounts
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-check me-2"></i>Record Deposit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Deposit Successful
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>Deposit Recorded Successfully!</h4>
                <p class="text-muted">The savings deposit has been processed and the member's account has been updated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{% url 'savings:deposit' %}" class="btn btn-success">Record Another Deposit</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update balance calculations when amount changes
document.addEventListener('DOMContentLoaded', function() {
    const memberSelect = document.querySelector('[name="member"]');
    const amountInput = document.querySelector('[name="amount"]');
    const balanceInfo = document.getElementById('balanceInfo');
    
    // Member selection change
    if (memberSelect) {
        memberSelect.addEventListener('change', function() {
            if (this.value) {
                fetchMemberBalance(this.value);
                balanceInfo.style.display = 'block';
            } else {
                balanceInfo.style.display = 'none';
            }
        });
    }
    
    // Amount input change
    if (amountInput) {
        amountInput.addEventListener('input', function() {
            updateNewBalance();
        });
    }
    
    // Pre-select member if passed in URL
    const urlParams = new URLSearchParams(window.location.search);
    const memberId = urlParams.get('member');
    if (memberId && memberSelect) {
        memberSelect.value = memberId;
        memberSelect.dispatchEvent(new Event('change'));
    }
});

function fetchMemberBalance(memberId) {
    // In a real implementation, this would fetch from an API
    // For now, we'll use placeholder values
    document.getElementById('currentBalance').textContent = '₦0.00';
    document.getElementById('minimumBalance').textContent = '₦1,000.00';
    updateNewBalance();
}

function updateNewBalance() {
    const currentBalance = parseFloat(document.getElementById('currentBalance').textContent.replace('₦', '').replace(',', '')) || 0;
    const depositAmount = parseFloat(document.querySelector('[name="amount"]').value) || 0;
    const newBalance = currentBalance + depositAmount;
    
    document.getElementById('newBalance').textContent = `₦${newBalance.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Form submission handling
document.getElementById('depositForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
});
</script>
{% endblock %}
