{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Members Directory - Cooperative Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Members Directory
                </h5>
                <div>
                    <a href="{% url 'members:register' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-user-plus me-1"></i>Add Member
                    </a>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#searchModal">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>{{ members.count }}</h4>
                                <small>Total Members</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4>{{ active_members_count }}</h4>
                                <small>Active Members</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h4>{{ pending_members_count }}</h4>
                                <small>Pending Approval</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>{{ new_this_month }}</h4>
                                <small>New This Month</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Members Table -->
                {% if members %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Member ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in members %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ member.member_id }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if member.user.profile_picture %}
                                            <img src="{{ member.user.profile_picture.url }}" alt="Profile" class="rounded-circle me-2" width="32" height="32">
                                        {% else %}
                                            <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <strong>{{ member.user.get_full_name }}</strong>
                                            <br><small class="text-muted">{{ member.occupation|default:"N/A" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ member.user.email }}</td>
                                <td>{{ member.user.phone_number|default:"N/A" }}</td>
                                <td>
                                    {% if member.membership_status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                    {% elif member.membership_status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif member.membership_status == 'suspended' %}
                                        <span class="badge bg-danger">Suspended</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ member.membership_status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ member.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'members:detail' member.pk %}" class="btn btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'members:edit' member.pk %}" class="btn btn-outline-secondary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-info" title="Savings" onclick="viewSavings({{ member.pk }})">
                                            <i class="fas fa-piggy-bank"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" title="Loans" onclick="viewLoans({{ member.pk }})">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </button>
                                        <button class="btn btn-outline-success" title="Change Monthly Deposit" onclick="changeMonthlyDeposit({{ member.pk }}, '{{ member.user.get_full_name }}', {{ member.monthly_savings }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <nav aria-label="Members pagination">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Members Found</h4>
                    <p class="text-muted">Start by registering your first member.</p>
                    <a href="{% url 'members:register' %}" class="btn btn-primary">
                        <i class="fas fa-user-plus me-2"></i>Register First Member
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Search Members
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get">
                <div class="modal-body">
                    {% crispy search_form %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Search
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Monthly Deposit Change Modal -->
<div class="modal fade" id="monthlyDepositModal" tabindex="-1" aria-labelledby="monthlyDepositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monthlyDepositModalLabel">
                    <i class="fas fa-edit me-2"></i>Change Monthly Deposit
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="monthlyDepositForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong id="memberNameDisplay"></strong>
                    </div>
                    
                    <div class="mb-3">
                        <label for="currentDeposit" class="form-label">Current Monthly Deposit</label>
                        <input type="text" class="form-control" id="currentDeposit" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newDeposit" class="form-label">New Monthly Deposit (₦)</label>
                        <input type="number" class="form-control" id="newDeposit" step="0.01" min="0" required>
                        <div class="form-text">This will affect loan eligibility and repayment capacity</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Change</label>
                        <textarea class="form-control" id="reason" rows="3" placeholder="Optional reason for the change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Update Deposit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewSavings(memberId) {
    window.location.href = `/savings/member/${memberId}/`;
}

function viewLoans(memberId) {
    window.location.href = `/loans/member/${memberId}/`;
}

let currentMemberId = null;

function changeMonthlyDeposit(memberId, memberName, currentAmount) {
    currentMemberId = memberId;
    document.getElementById('memberNameDisplay').textContent = memberName;
    document.getElementById('currentDeposit').value = `₦${parseFloat(currentAmount).toLocaleString()}`;
    document.getElementById('newDeposit').value = currentAmount;
    document.getElementById('reason').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('monthlyDepositModal'));
    modal.show();
}

// Handle monthly deposit form submission
document.getElementById('monthlyDepositForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newAmount = document.getElementById('newDeposit').value;
    const reason = document.getElementById('reason').value;
    
    if (!newAmount || parseFloat(newAmount) < 0) {
        alert('Please enter a valid monthly deposit amount.');
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;
    
    // Send AJAX request
    fetch(`/members/${currentMemberId}/update-monthly-deposit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `monthly_deposit=${newAmount}&reason=${encodeURIComponent(reason)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showAlert('success', data.message);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('monthlyDepositModal'));
            modal.hide();
            
            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while updating monthly deposit.');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.row');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Auto-submit search form on input change
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('#searchModal form');
    if (searchForm) {
        const inputs = searchForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                // Auto-submit after short delay
                setTimeout(() => {
                    searchForm.submit();
                }, 500);
            });
        });
    }
});
</script>
{% endblock %}
