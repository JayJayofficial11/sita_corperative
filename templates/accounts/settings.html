{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Account Settings - {{ user.get_full_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Account Settings
                </h5>
                <a href="{% url 'accounts:profile' %}" class="btn btn-light btn-sm">
                    <i class="fas fa-user me-1"></i>Back to Profile
                </a>
            </div>
            
            <div class="card-body">
                <!-- Settings Tabs -->
                <ul class="nav nav-tabs mb-4" id="settingsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="account-tab" data-bs-toggle="tab" data-bs-target="#account-settings" type="button" role="tab">
                            <i class="fas fa-user-cog me-1"></i>Account
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-settings" type="button" role="tab">
                            <i class="fas fa-shield-alt me-1"></i>Security
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preference-settings" type="button" role="tab">
                            <i class="fas fa-sliders-h me-1"></i>Preferences
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="privacy-tab" data-bs-toggle="tab" data-bs-target="#privacy-settings" type="button" role="tab">
                            <i class="fas fa-user-secret me-1"></i>Privacy
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="settingsTabContent">
                    <!-- Account Settings -->
                    <div class="tab-pane fade show active" id="account-settings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user me-2"></i>Basic Information
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" action="{% url 'accounts:update_account' %}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="email" class="form-label">Email Address</label>
                                                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="timezone" class="form-label">Timezone</label>
                                                <select class="form-select" id="timezone" name="timezone">
                                                    <option value="Africa/Lagos" {% if user.profile.timezone == 'Africa/Lagos' %}selected{% endif %}>Lagos (WAT)</option>
                                                    <option value="UTC" {% if user.profile.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Update Account
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-info-circle me-2"></i>Account Status
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li class="mb-3">
                                                <strong>Account Type:</strong>
                                                <span class="badge bg-{% if user.is_staff %}warning{% elif user.member %}success{% else %}secondary{% endif %} ms-2">
                                                    {% if user.is_staff %}Staff{% elif user.member %}Member{% else %}User{% endif %}
                                                </span>
                                            </li>
                                            <li class="mb-3">
                                                <strong>Status:</strong>
                                                <span class="badge bg-{% if user.is_active %}success{% else %}danger{% endif %} ms-2">
                                                    {% if user.is_active %}Active{% else %}Inactive{% endif %}
                                                </span>
                                            </li>
                                            <li class="mb-3">
                                                <strong>Email Verified:</strong>
                                                <span class="badge bg-{% if user.profile.email_verified %}success{% else %}warning{% endif %} ms-2">
                                                    {% if user.profile.email_verified %}Verified{% else %}Pending{% endif %}
                                                </span>
                                                {% if not user.profile.email_verified %}
                                                    <button class="btn btn-sm btn-warning ms-2" onclick="resendVerification()">
                                                        Resend
                                                    </button>
                                                {% endif %}
                                            </li>
                                            <li class="mb-3">
                                                <strong>Member Since:</strong>
                                                {{ user.date_joined|date:"F d, Y" }}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security-settings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">
                                            <i class="fas fa-key me-2"></i>Password Management
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" action="{% url 'accounts:change_password' %}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="current_password" class="form-label">Current Password</label>
                                                <input type="password" class="form-control" id="current_password" name="old_password" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_password" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="new_password" name="new_password1" required>
                                                <div class="form-text">Password must be at least 8 characters long.</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confirm_password" class="form-label">Confirm New Password</label>
                                                <input type="password" class="form-control" id="confirm_password" name="new_password2" required>
                                            </div>
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-key me-2"></i>Change Password
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt me-2"></i>Two-Factor Authentication
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if user.profile.two_factor_enabled %}
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                Two-factor authentication is enabled
                                            </div>
                                            <button class="btn btn-danger" onclick="disableTwoFactor()">
                                                <i class="fas fa-times me-2"></i>Disable 2FA
                                            </button>
                                            <button class="btn btn-secondary" onclick="viewBackupCodes()">
                                                <i class="fas fa-key me-2"></i>Backup Codes
                                            </button>
                                        {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                Two-factor authentication is disabled
                                            </div>
                                            <p class="text-muted">Enhance your account security by enabling two-factor authentication.</p>
                                            <button class="btn btn-success" onclick="enableTwoFactor()">
                                                <i class="fas fa-shield-alt me-2"></i>Enable 2FA
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Login Sessions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-desktop me-2"></i>Active Sessions
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Device/Location</th>
                                                        <th>Last Activity</th>
                                                        <th>IP Address</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for session in active_sessions %}
                                                    <tr>
                                                        <td>
                                                            <i class="fas fa-{% if session.is_mobile %}mobile-alt{% else %}desktop{% endif %} me-2"></i>
                                                            {{ session.device_info|default:"Unknown Device" }}
                                                            {% if session.is_current %}
                                                                <span class="badge bg-success ms-2">Current</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ session.last_activity|timesince }} ago</td>
                                                        <td>{{ session.ip_address }}</td>
                                                        <td>
                                                            <span class="badge bg-{% if session.is_active %}success{% else %}secondary{% endif %}">
                                                                {% if session.is_active %}Active{% else %}Expired{% endif %}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            {% if not session.is_current and session.is_active %}
                                                                <button class="btn btn-sm btn-danger" onclick="terminateSession('{{ session.id }}')">
                                                                    <i class="fas fa-sign-out-alt"></i>
                                                                </button>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="5" class="text-center text-muted py-4">
                                                            No active sessions found.
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button class="btn btn-warning" onclick="terminateAllSessions()">
                                            <i class="fas fa-sign-out-alt me-2"></i>Terminate All Other Sessions
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preference Settings -->
                    <div class="tab-pane fade" id="preference-settings" role="tabpanel">
                        <form method="post" action="{% url 'accounts:update_preferences' %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-palette me-2"></i>Display Preferences
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="theme" class="form-label">Theme</label>
                                                <select class="form-select" id="theme" name="theme">
                                                    <option value="light" {% if user.profile.theme == 'light' %}selected{% endif %}>Light</option>
                                                    <option value="dark" {% if user.profile.theme == 'dark' %}selected{% endif %}>Dark</option>
                                                    <option value="auto" {% if user.profile.theme == 'auto' %}selected{% endif %}>Auto</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="language" class="form-label">Language</label>
                                                <select class="form-select" id="language" name="language">
                                                    <option value="en" {% if user.profile.language == 'en' %}selected{% endif %}>English</option>
                                                    <option value="fr" {% if user.profile.language == 'fr' %}selected{% endif %}>French</option>
                                                    <option value="ha" {% if user.profile.language == 'ha' %}selected{% endif %}>Hausa</option>
                                                    <option value="yo" {% if user.profile.language == 'yo' %}selected{% endif %}>Yoruba</option>
                                                    <option value="ig" {% if user.profile.language == 'ig' %}selected{% endif %}>Igbo</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="currency" class="form-label">Currency Display</label>
                                                <select class="form-select" id="currency" name="currency">
                                                    <option value="NGN" {% if user.profile.currency == 'NGN' %}selected{% endif %}>Nigerian Naira (â‚¦)</option>
                                                    <option value="USD" {% if user.profile.currency == 'USD' %}selected{% endif %}>US Dollar ($)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-bell me-2"></i>Notification Preferences
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" {% if user.profile.email_notifications %}checked{% endif %}>
                                                <label class="form-check-label" for="email_notifications">
                                                    Email notifications
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="sms_notifications" name="sms_notifications" {% if user.profile.sms_notifications %}checked{% endif %}>
                                                <label class="form-check-label" for="sms_notifications">
                                                    SMS notifications
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="push_notifications" name="push_notifications" {% if user.profile.push_notifications %}checked{% endif %}>
                                                <label class="form-check-label" for="push_notifications">
                                                    Push notifications
                                                </label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="marketing_emails" name="marketing_emails" {% if user.profile.marketing_emails %}checked{% endif %}>
                                                <label class="form-check-label" for="marketing_emails">
                                                    Marketing emails
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Save Preferences
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Privacy Settings -->
                    <div class="tab-pane fade" id="privacy-settings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user-secret me-2"></i>Privacy Controls
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" action="{% url 'accounts:update_privacy' %}">
                                            {% csrf_token %}
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="profile_public" name="profile_public" {% if user.profile.profile_public %}checked{% endif %}>
                                                <label class="form-check-label" for="profile_public">
                                                    Make profile visible to other members
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="activity_visible" name="activity_visible" {% if user.profile.activity_visible %}checked{% endif %}>
                                                <label class="form-check-label" for="activity_visible">
                                                    Show activity status
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="contact_info_visible" name="contact_info_visible" {% if user.profile.contact_info_visible %}checked{% endif %}>
                                                <label class="form-check-label" for="contact_info_visible">
                                                    Allow members to see contact info
                                                </label>
                                            </div>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-2"></i>Save Privacy Settings
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <h6>Download Your Data</h6>
                                            <p class="text-muted">Download a copy of all your personal data.</p>
                                            <button class="btn btn-outline-primary" onclick="downloadUserData()">
                                                <i class="fas fa-download me-2"></i>Download Data
                                            </button>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Deactivate Account</h6>
                                            <p class="text-muted">Temporarily disable your account. You can reactivate it anytime.</p>
                                            <button class="btn btn-warning" onclick="deactivateAccount()">
                                                <i class="fas fa-pause me-2"></i>Deactivate Account
                                            </button>
                                        </div>
                                        
                                        {% if not user.member or user.member.can_delete %}
                                        <div>
                                            <h6 class="text-danger">Delete Account</h6>
                                            <p class="text-muted">Permanently delete your account and all associated data. This action cannot be undone.</p>
                                            <button class="btn btn-danger" onclick="deleteAccount()">
                                                <i class="fas fa-trash me-2"></i>Delete Account
                                            </button>
                                        </div>
                                        {% else %}
                                        <div>
                                            <h6 class="text-muted">Delete Account</h6>
                                            <p class="text-muted">Account deletion is not available due to active financial obligations.</p>
                                            <button class="btn btn-secondary" disabled>
                                                <i class="fas fa-lock me-2"></i>Cannot Delete
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function enableTwoFactor() {
    if (confirm('Enable two-factor authentication? You will need an authenticator app.')) {
        window.location.href = '{% url "accounts:setup_2fa" %}';
    }
}

function disableTwoFactor() {
    if (confirm('Disable two-factor authentication? This will reduce your account security.')) {
        fetch('{% url "accounts:disable_2fa" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Two-factor authentication disabled.');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert('danger', 'Failed to disable 2FA.');
            }
        });
    }
}

function viewBackupCodes() {
    window.location.href = '{% url "accounts:backup_codes" %}';
}

function resendVerification() {
    fetch('{% url "accounts:resend_verification" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Verification email sent!');
        } else {
            showAlert('danger', 'Failed to send verification email.');
        }
    });
}

function terminateSession(sessionId) {
    if (confirm('Terminate this session?')) {
        fetch('{% url "accounts:terminate_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ session_id: sessionId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Session terminated.');
                location.reload();
            } else {
                showAlert('danger', 'Failed to terminate session.');
            }
        });
    }
}

function terminateAllSessions() {
    if (confirm('Terminate all other sessions? You will need to log in again on other devices.')) {
        fetch('{% url "accounts:terminate_all_sessions" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'All other sessions terminated.');
                location.reload();
            } else {
                showAlert('danger', 'Failed to terminate sessions.');
            }
        });
    }
}

function downloadUserData() {
    if (confirm('Download all your data? This may take a few minutes.')) {
        window.location.href = '{% url "accounts:download_data" %}';
    }
}

function deactivateAccount() {
    if (confirm('Deactivate your account? You can reactivate it anytime by logging in.')) {
        window.location.href = '{% url "accounts:deactivate" %}';
    }
}

function deleteAccount() {
    const confirmation = prompt('Type "DELETE" to confirm account deletion:');
    if (confirmation === 'DELETE') {
        if (confirm('Are you absolutely sure? This action cannot be undone.')) {
            window.location.href = '{% url "accounts:delete_account" %}';
        }
    }
}

// Show success messages
{% if messages %}
    {% for message in messages %}
        showAlert('{{ message.tags }}', '{{ message }}');
    {% endfor %}
{% endif %}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.row');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
