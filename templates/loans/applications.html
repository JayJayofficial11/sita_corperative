{% extends 'base/base.html' %}
{% load static %}

{% block title %}Loan Applications{% endblock %}

{% block extra_css %}
<style>
    .loan-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .loan-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .action-buttons {
        gap: 0.5rem;
    }
    
    /* Ensure modal forms work properly */
    .modal form {
        margin: 0;
    }
    
    .modal .btn[type="submit"] {
        pointer-events: auto !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
<div class="row">
    <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-alt me-2"></i>Loan Applications</h2>
                <a href="{% url 'loans:apply' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Application
                </a>
            </div>

            <!-- Search and Filter Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ request.GET.search }}" placeholder="Search by loan ID or member name...">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Statuses</option>
                                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                                <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ request.GET.start_date }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search me-1"></i>Search
                    </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">{{ pending_applications }}</h5>
                            <p class="card-text">Pending Applications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">{{ approved_applications }}</h5>
                            <p class="card-text">Approved Applications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger">{{ rejected_applications }}</h5>
                            <p class="card-text">Rejected Applications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">₦{{ total_requested|floatformat:2 }}</h5>
                            <p class="card-text">Total Requested</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- Loan Applications List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">All Loan Applications</h5>
                </div>
                <div class="card-body">
                    {% if loans %}
                <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Member</th>
                                        <th>Amount</th>
                                        <th>Product</th>
                                        <th>Application Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                                    {% for loan in loans %}
                                    <tr>
                                        <td><strong>{{ loan.loan_id }}</strong></td>
                                        <td>{{ loan.member.user.get_full_name }}</td>
                                        <td>₦{{ loan.requested_amount|floatformat:2 }}</td>
                                        <td>{{ loan.loan_product.name }}</td>
                                        <td>{{ loan.application_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if loan.status == 'pending' %}
                                                <span class="badge bg-warning status-badge">Pending</span>
                                    {% elif loan.status == 'approved' %}
                                                <span class="badge bg-success status-badge">Approved</span>
                                    {% elif loan.status == 'rejected' %}
                                                <span class="badge bg-danger status-badge">Rejected</span>
                                            {% elif loan.status == 'active' %}
                                                <span class="badge bg-info status-badge">Active</span>
                                            {% elif loan.status == 'completed' %}
                                                <span class="badge bg-secondary status-badge">Completed</span>
                                    {% endif %}
                                </td>
                                <td>
                                            <div class="d-flex action-buttons">
                                                <a href="{% url 'loans:detail' loan.pk %}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if loan.status == 'pending' %}
                                                    <button type="button" class="btn btn-sm btn-success" 
                                                            onclick="approveLoan('{{ loan.pk }}', '{{ loan.requested_amount }}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                                    <button type="button" class="btn btn-sm btn-danger" 
                                                            onclick="rejectLoan('{{ loan.pk }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% elif loan.status == 'approved' %}
                                                    <a href="{% url 'loans:disburse' loan.pk %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <nav aria-label="Loan applications pagination">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                            <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
                            </li>
                        {% endif %}
                        
                                <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                        </span>
                                </li>
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Last</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Loan Applications Found</h5>
                    <p class="text-muted">Loan applications will appear here when members apply for loans.</p>
                </div>
                {% endif %}
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Simplified Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="approvalModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Approve Loan Application
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="approvalForm" action="{% url 'loans:applications' %}" class="modal-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="approve">
                <input type="hidden" name="loan_id" id="approvalLoanId">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Interest rate is fixed at 10% and tenure at 22 months.
                    </div>
                    
                    <div class="mb-3">
                        <label for="requested_amount" class="form-label">Requested Amount (₦)</label>
                        <input type="number" class="form-control" id="requested_amount" name="requested_amount" 
                               step="0.01" min="0" readonly placeholder="Requested amount">
                        <div class="form-text">Amount requested by the member</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="approved_amount" class="form-label">Approved Amount (₦) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="approved_amount" name="approved_amount" 
                                   step="0.01" min="0" required placeholder="Enter approved amount">
                            <button type="button" class="btn btn-outline-secondary" onclick="copyRequestedAmount()">
                                <i class="fas fa-copy me-1"></i>Copy Requested
                            </button>
                        </div>
                        <div class="form-text">Amount to be approved (can be less than requested)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="approval_notes" class="form-label">Approval Notes</label>
                        <textarea name="approval_notes" id="approval_notes" class="form-control" rows="3" 
                                  placeholder="Optional notes about this approval..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success" id="approveBtn">
                        <i class="fas fa-check me-2"></i>Approve Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectionModalLabel">Reject Loan Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="rejectionForm" action="{% url 'loans:applications' %}" class="modal-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject">
                <input type="hidden" name="loan_id" id="rejectionLoanId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejection_reason" class="form-label">Reason for Rejection</label>
                        <textarea name="rejection_reason" id="rejection_reason" class="form-control" rows="4" 
                                  required placeholder="Please provide a detailed reason for rejecting this loan application..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="rejectBtn">
                        <i class="fas fa-times me-2"></i>Reject Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple functions to open modals
function approveLoan(loanId, requestedAmount) {
    console.log('Opening approval modal for loan:', loanId);
    document.getElementById('approvalLoanId').value = loanId;
    document.getElementById('requested_amount').value = requestedAmount;
    document.getElementById('approved_amount').value = requestedAmount; // Pre-fill with requested amount
    document.getElementById('approval_notes').value = '';
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

function rejectLoan(loanId) {
    console.log('Opening rejection modal for loan:', loanId);
    document.getElementById('rejectionLoanId').value = loanId;
    const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));
    modal.show();
}

function copyRequestedAmount() {
    const requestedAmount = document.getElementById('requested_amount').value;
    document.getElementById('approved_amount').value = requestedAmount;
}

// Handle form submissions - OVERRIDE ANY GLOBAL HANDLERS
document.addEventListener('DOMContentLoaded', function() {
    console.log('Loan applications page loaded');
    
    // Override any global form handlers for modal forms
    const modalForms = document.querySelectorAll('.modal-form');
    modalForms.forEach(function(form) {
        // Remove any existing event listeners by cloning the form
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        // Add our own submit handler
        newForm.addEventListener('submit', function(e) {
            console.log('Modal form submitted:', this.id);
            
            // Basic validation
            const requiredFields = this.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(function(field) {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return false;
            }
            
            console.log('Form validation passed, submitting...');
            // Let the form submit normally
            return true;
        });
    });
    
    // Also handle the specific forms by ID
    const approvalForm = document.getElementById('approvalForm');
    if (approvalForm) {
        approvalForm.addEventListener('submit', function(e) {
            console.log('Approval form submitted');
            
            const approvedAmount = document.getElementById('approved_amount').value;
            const requestedAmount = document.getElementById('requested_amount').value;
            
            if (!approvedAmount || parseFloat(approvedAmount) <= 0) {
                e.preventDefault();
                alert('Please provide a valid approved amount.');
                return false;
            }
            
            if (parseFloat(approvedAmount) > parseFloat(requestedAmount)) {
                e.preventDefault();
                alert('Approved amount cannot be greater than requested amount.');
                return false;
            }
            
            console.log('Approval form validation passed, submitting...');
            // Let the form submit normally
            return true;
        });
    }
    
    const rejectionForm = document.getElementById('rejectionForm');
    if (rejectionForm) {
        rejectionForm.addEventListener('submit', function(e) {
            console.log('Rejection form submitted');
            
            const rejectionReason = document.getElementById('rejection_reason').value;
            
            if (!rejectionReason.trim()) {
                e.preventDefault();
                alert('Please provide a reason for rejection.');
                return false;
            }
            
            console.log('Rejection form validation passed, submitting...');
            // Let the form submit normally
        });
    }
});
</script>
{% endblock %}
