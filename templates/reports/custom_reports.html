{% extends "base/base.html" %}
{% load static %}

{% block title %}Custom Reports{% endblock %}

{% block extra_css %}
<style>
.report-builder {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.form-section {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: #f8f9fa;
}

.form-section.active {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.preview-area {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 2rem;
    min-height: 200px;
    border: 2px dashed #dee2e6;
}

.field-selector {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 0.5rem;
    margin: 0.25rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.field-selector:hover {
    background: #e9ecef;
    border-color: #667eea;
}

.field-selector.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.template-card {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.template-card:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.template-card.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-0">
                        <i class="fas fa-magic text-primary me-3"></i>
                        Custom Report Builder
                    </h1>
                    <p class="text-muted">Build custom reports with advanced filtering and formatting options</p>
                </div>
                <div>
                    <button class="btn btn-success" onclick="saveTemplate()">
                        <i class="fas fa-save me-2"></i>Save Template
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-chart-bar me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Report Builder -->
        <div class="col-md-8">
            <div class="report-builder">
                <form id="customReportForm">
                    {% csrf_token %}
                    {{ form.as_p }}
                    
                    <!-- Data Source Selection -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-database me-2"></i>
                            Data Source
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Primary Table</label>
                                    <select class="form-select" name="primary_table" id="primaryTable">
                                        <option value="">Select Primary Table</option>
                                        <option value="members">Members</option>
                                        <option value="savings">Savings Accounts</option>
                                        <option value="loans">Loans</option>
                                        <option value="transactions">Transactions</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Join Tables (Optional)</label>
                                    <select class="form-select" name="join_tables" multiple>
                                        <option value="user_profile">User Profile</option>
                                        <option value="savings_transactions">Savings Transactions</option>
                                        <option value="loan_repayments">Loan Repayments</option>
                                        <option value="account_entries">Account Entries</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Selection -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-list me-2"></i>
                            Select Fields
                        </h5>
                        <div id="fieldSelector">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6>Member Fields</h6>
                                    <div class="field-selector" data-field="member_id">Member ID</div>
                                    <div class="field-selector" data-field="full_name">Full Name</div>
                                    <div class="field-selector" data-field="email">Email</div>
                                    <div class="field-selector" data-field="phone">Phone</div>
                                    <div class="field-selector" data-field="join_date">Join Date</div>
                                    <div class="field-selector" data-field="status">Status</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Financial Fields</h6>
                                    <div class="field-selector" data-field="total_savings">Total Savings</div>
                                    <div class="field-selector" data-field="total_loans">Total Loans</div>
                                    <div class="field-selector" data-field="account_balance">Account Balance</div>
                                    <div class="field-selector" data-field="outstanding_balance">Outstanding Balance</div>
                                    <div class="field-selector" data-field="monthly_deposits">Monthly Deposits</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Transaction Fields</h6>
                                    <div class="field-selector" data-field="transaction_date">Transaction Date</div>
                                    <div class="field-selector" data-field="transaction_type">Transaction Type</div>
                                    <div class="field-selector" data-field="amount">Amount</div>
                                    <div class="field-selector" data-field="description">Description</div>
                                    <div class="field-selector" data-field="reference">Reference</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Calculated Fields</h6>
                                    <div class="field-selector" data-field="net_worth">Net Worth</div>
                                    <div class="field-selector" data-field="savings_growth">Savings Growth</div>
                                    <div class="field-selector" data-field="loan_ratio">Loan-to-Savings Ratio</div>
                                    <div class="field-selector" data-field="activity_score">Activity Score</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-filter me-2"></i>
                            Filters & Conditions
                        </h5>
                        <div id="filterBuilder">
                            <div class="row filter-row">
                                <div class="col-md-3">
                                    <select class="form-select" name="filter_field[]">
                                        <option value="">Select Field</option>
                                        <option value="status">Status</option>
                                        <option value="join_date">Join Date</option>
                                        <option value="balance">Balance</option>
                                        <option value="loan_amount">Loan Amount</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" name="filter_operator[]">
                                        <option value="equals">Equals</option>
                                        <option value="not_equals">Not Equals</option>
                                        <option value="greater_than">Greater Than</option>
                                        <option value="less_than">Less Than</option>
                                        <option value="contains">Contains</option>
                                        <option value="between">Between</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="filter_value[]" placeholder="Value">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary" onclick="addFilter()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sorting & Grouping -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-sort me-2"></i>
                            Sorting & Grouping
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sort By</label>
                                    <select class="form-select" name="sort_by">
                                        <option value="">No Sorting</option>
                                        <option value="name">Name</option>
                                        <option value="date">Date</option>
                                        <option value="amount">Amount</option>
                                        <option value="balance">Balance</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sort Order</label>
                                    <select class="form-select" name="sort_order">
                                        <option value="asc">Ascending</option>
                                        <option value="desc">Descending</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Group By</label>
                                    <select class="form-select" name="group_by">
                                        <option value="">No Grouping</option>
                                        <option value="status">Status</option>
                                        <option value="month">Month</option>
                                        <option value="product">Product Type</option>
                                        <option value="branch">Branch</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Output Format -->
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="fas fa-file-export me-2"></i>
                            Output Format
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Format</label>
                                    <select class="form-select" name="output_format">
                                        <option value="table">Table View</option>
                                        <option value="chart">Chart/Graph</option>
                                        <option value="summary">Summary Cards</option>
                                        <option value="pivot">Pivot Table</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Chart Type</label>
                                    <select class="form-select" name="chart_type">
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="area">Area Chart</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Export As</label>
                                    <select class="form-select" name="export_format">
                                        <option value="html">View Online</option>
                                        <option value="pdf">PDF Download</option>
                                        <option value="excel">Excel File</option>
                                        <option value="csv">CSV File</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Templates & Preview -->
        <div class="col-md-4">
            <!-- Report Templates -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-folder-open me-2"></i>
                        Report Templates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="template-card" onclick="loadTemplate('member_summary')">
                        <h6 class="mb-1">Member Summary</h6>
                        <small class="text-muted">Complete member overview with financial data</small>
                    </div>
                    <div class="template-card" onclick="loadTemplate('financial_dashboard')">
                        <h6 class="mb-1">Financial Dashboard</h6>
                        <small class="text-muted">Key financial metrics and trends</small>
                    </div>
                    <div class="template-card" onclick="loadTemplate('activity_report')">
                        <h6 class="mb-1">Activity Report</h6>
                        <small class="text-muted">Member activity and engagement analysis</small>
                    </div>
                    <div class="template-card" onclick="loadTemplate('compliance_report')">
                        <h6 class="mb-1">Compliance Report</h6>
                        <small class="text-muted">Regulatory compliance and audit trail</small>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Report Preview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="preview-area" id="reportPreview">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>Select fields and filters to preview your report</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="updatePreview()">
                            <i class="fas fa-refresh me-2"></i>Update Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Options -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Advanced Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_charts" id="includeCharts">
                                <label class="form-check-label" for="includeCharts">
                                    Include Visual Charts
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_totals" id="includeTotals" checked>
                                <label class="form-check-label" for="includeTotals">
                                    Include Summary Totals
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="auto_refresh" id="autoRefresh">
                                <label class="form-check-label" for="autoRefresh">
                                    Auto-refresh Data
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="email_schedule" id="emailSchedule">
                                <label class="form-check-label" for="emailSchedule">
                                    Schedule Email Delivery
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Template Modal -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Report Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saveTemplateForm">
                    <div class="mb-3">
                        <label class="form-label">Template Name</label>
                        <input type="text" class="form-control" name="template_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="template_description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_public" id="isPublic">
                            <label class="form-check-label" for="isPublic">
                                Share with other users
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplateData()">
                    <i class="fas fa-save me-2"></i>Save Template
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Field selector functionality
    document.querySelectorAll('.field-selector').forEach(field => {
        field.addEventListener('click', function() {
            this.classList.toggle('selected');
            updateSelectedFields();
        });
    });

    // Template card selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // Form section highlighting
    document.querySelectorAll('.form-section').forEach(section => {
        section.addEventListener('focusin', function() {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

function addFilter() {
    const filterBuilder = document.getElementById('filterBuilder');
    const newRow = document.createElement('div');
    newRow.className = 'row filter-row mt-2';
    newRow.innerHTML = `
        <div class="col-md-3">
            <select class="form-select" name="filter_field[]">
                <option value="">Select Field</option>
                <option value="status">Status</option>
                <option value="join_date">Join Date</option>
                <option value="balance">Balance</option>
                <option value="loan_amount">Loan Amount</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" name="filter_operator[]">
                <option value="equals">Equals</option>
                <option value="not_equals">Not Equals</option>
                <option value="greater_than">Greater Than</option>
                <option value="less_than">Less Than</option>
                <option value="contains">Contains</option>
                <option value="between">Between</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control" name="filter_value[]" placeholder="Value">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger" onclick="removeFilter(this)">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    `;
    filterBuilder.appendChild(newRow);
}

function removeFilter(button) {
    button.closest('.filter-row').remove();
}

function updateSelectedFields() {
    const selected = document.querySelectorAll('.field-selector.selected');
    const fieldList = Array.from(selected).map(field => field.dataset.field);
    
    // Update hidden input or form data
    const hiddenInput = document.getElementById('selectedFields') || document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'selected_fields';
    hiddenInput.id = 'selectedFields';
    hiddenInput.value = fieldList.join(',');
    
    if (!hiddenInput.parentNode) {
        document.getElementById('customReportForm').appendChild(hiddenInput);
    }
    
    updatePreview();
}

function updatePreview() {
    const previewArea = document.getElementById('reportPreview');
    const selectedFields = document.querySelectorAll('.field-selector.selected');
    
    if (selectedFields.length === 0) {
        previewArea.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                <p>Select fields to preview your report</p>
            </div>
        `;
        return;
    }
    
    // Generate preview content
    let previewHtml = '<div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr>';
    
    selectedFields.forEach(field => {
        previewHtml += `<th>${field.textContent}</th>`;
    });
    
    previewHtml += '</tr></thead><tbody>';
    
    // Sample data rows
    for (let i = 0; i < 3; i++) {
        previewHtml += '<tr>';
        selectedFields.forEach((field, index) => {
            previewHtml += `<td>Sample ${index + 1}</td>`;
        });
        previewHtml += '</tr>';
    }
    
    previewHtml += '</tbody></table></div><small class="text-muted">Preview shows sample data structure</small>';
    
    previewArea.innerHTML = previewHtml;
}

function loadTemplate(templateName) {
    // Simulate loading a template
    showAlert('info', `Loading ${templateName.replace('_', ' ')} template...`);
    
    setTimeout(() => {
        // Reset selections
        document.querySelectorAll('.field-selector').forEach(field => {
            field.classList.remove('selected');
        });
        
        // Select fields based on template
        const templateFields = {
            'member_summary': ['member_id', 'full_name', 'email', 'total_savings', 'total_loans', 'status'],
            'financial_dashboard': ['total_savings', 'total_loans', 'account_balance', 'monthly_deposits'],
            'activity_report': ['full_name', 'transaction_date', 'transaction_type', 'amount'],
            'compliance_report': ['member_id', 'full_name', 'join_date', 'status', 'outstanding_balance']
        };
        
        const fields = templateFields[templateName] || [];
        fields.forEach(fieldName => {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            if (fieldElement) {
                fieldElement.classList.add('selected');
            }
        });
        
        updateSelectedFields();
        showAlert('success', 'Template loaded successfully!');
    }, 1000);
}

function saveTemplate() {
    const modal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
    modal.show();
}

function saveTemplateData() {
    const form = document.getElementById('saveTemplateForm');
    const formData = new FormData(form);
    
    // Show loading state
    const button = event.target;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    button.disabled = true;
    
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('saveTemplateModal')).hide();
        showAlert('success', 'Template saved successfully!');
        
        // Reset button
        button.innerHTML = '<i class="fas fa-save me-2"></i>Save Template';
        button.disabled = false;
        
        // Reset form
        form.reset();
    }, 2000);
}

function generateReport() {
    const form = document.getElementById('customReportForm');
    const formData = new FormData(form);
    
    // Validate form
    const selectedFields = document.querySelectorAll('.field-selector.selected');
    if (selectedFields.length === 0) {
        showAlert('warning', 'Please select at least one field for your report.');
        return;
    }
    
    // Show loading state
    const button = event.target;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;
    
    setTimeout(() => {
        showAlert('success', 'Custom report generated successfully!');
        
        // Reset button
        button.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Generate Report';
        button.disabled = false;
        
        // Here you would navigate to the generated report or open it in a new tab
        // window.open('/reports/custom/view/?report_id=12345', '_blank');
    }, 3000);
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => alertDiv.remove(), 5000);
}

// Auto-save functionality
let autoSaveTimer;
function autoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        const formData = new FormData(document.getElementById('customReportForm'));
        // Save to localStorage or send to server
        localStorage.setItem('customReportDraft', JSON.stringify(Object.fromEntries(formData)));
        console.log('Report draft auto-saved');
    }, 5000);
}

// Trigger auto-save on form changes
document.getElementById('customReportForm').addEventListener('input', autoSave);
</script>
{% endblock %}
